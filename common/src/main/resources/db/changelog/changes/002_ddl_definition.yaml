databaseChangeLog:
  - changeSet:
      id: 002_ddl_definition
      author: system
      changes:
        - createTable:
            tableName: definition
            columns:
              - column:
                  name: code
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: int
                  defaultValueNumeric: 1
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: varchar(20)
                  constraints:
                    nullable: false
              - column:
                  name: is_current
                  type: boolean
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: schema_lob
                  type: clob
                  constraints:
                    nullable: false
              - column:
                  name: validation_rules_lob
                  type: clob
              - column:
                  name: created_by
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_by
                  type: varchar(255)
              - column:
                  name: updated_at
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: deleted_by
                  type: varchar(255)
              - column:
                  name: deleted_at
                  type: timestamp

        - addPrimaryKey:
            tableName: definition
            columnNames: code, version
            constraintName: pk_definition

        - createIndex:
            tableName: definition
            indexName: idx_def_status_current
            columns:
              - column:
                  name: is_current
              - column:
                  name: status

        - sql:
            sql: >
              ALTER TABLE definition ADD CONSTRAINT chk_def_status 
              CHECK (status IN ('DRAFT','ACTIVE','ARCHIVED'));
              
              ALTER TABLE definition ADD CONSTRAINT chk_def_ver_pos 
              CHECK (version > 0);
              
              ALTER TABLE definition ADD CONSTRAINT chk_def_del_consistency 
              CHECK ((deleted_at IS NULL AND deleted_by IS NULL) OR (deleted_at IS NOT NULL AND deleted_by IS NOT NULL));